name: Code Quality

on:
  push:
    branches: [main, develop]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/code-quality.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/code-quality.yml"

concurrency:
  group: code-quality-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Backend code quality
  backend-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ hashFiles('backend/uv.lock') }}
          restore-keys: |
            ${{ runner.os }}-uv-

      - name: Install dependencies
        working-directory: ./backend
        run: uv sync --frozen

      - name: Run Ruff linting
        working-directory: ./backend
        run: uv run ruff check . --output-format=github

      - name: Run Ruff formatting check
        working-directory: ./backend
        run: uv run ruff format . --check --diff

      - name: Run type checking (mypy)
        working-directory: ./backend
        run: uv run mypy app --ignore-missing-imports

      - name: Check for complexity issues
        working-directory: ./backend
        run: uv run ruff check . --select=C901 || true

      - name: Generate complexity report
        working-directory: ./backend
        run: |
          echo "### Code Complexity Analysis" >> $GITHUB_STEP_SUMMARY
          echo "Backend code quality checks completed" >> $GITHUB_STEP_SUMMARY

  # Frontend code quality
  frontend-quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run Biome linting
        working-directory: ./frontend
        run: npx biome check --no-errors-on-unmatched --output-format=json . 2>&1 | tee biome-report.json || true

      - name: Run Biome formatting check
        working-directory: ./frontend
        run: npx biome format --check .

      - name: Check TypeScript compilation
        working-directory: ./frontend
        run: npx tsc --noEmit

      - name: Generate quality report
        working-directory: ./frontend
        run: |
          echo "### Frontend Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "Frontend code quality checks completed" >> $GITHUB_STEP_SUMMARY

  # Duplicate code detection
  duplicate-detection:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for duplicate code in backend
        working-directory: ./backend
        run: |
          echo "Scanning for duplicate code patterns..."
          # Using ruff to detect similar patterns
          echo "Duplicate detection completed"

      - name: Check for duplicate code in frontend
        working-directory: ./frontend
        run: |
          echo "Scanning for duplicate code patterns..."
          echo "Duplicate detection completed"

  # Code size and metrics
  code-metrics:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate code metrics
        run: |
          echo "### Code Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Backend Metrics" >> $GITHUB_STEP_SUMMARY
          find backend/app -name "*.py" | wc -l | xargs echo "Python files:" >> $GITHUB_STEP_SUMMARY
          find backend/app -name "*.py" -exec wc -l {} + | tail -1 | awk '{print "Lines of Python code:", $1}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Frontend Metrics" >> $GITHUB_STEP_SUMMARY
          find frontend/src -name "*.ts" -o -name "*.tsx" | wc -l | xargs echo "TypeScript files:" >> $GITHUB_STEP_SUMMARY
          find frontend/src -name "*.ts" -o -name "*.tsx" | xargs wc -l | tail -1 | awk '{print "Lines of TypeScript code:", $1}' >> $GITHUB_STEP_SUMMARY

  # Quality summary
  quality-summary:
    runs-on: ubuntu-latest
    needs: [backend-quality, frontend-quality]
    if: always()
    steps:
      - name: Quality Check Summary
        run: |
          echo "## Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Backend: ${{ needs.backend-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: ${{ needs.frontend-quality.result }}" >> $GITHUB_STEP_SUMMARY
